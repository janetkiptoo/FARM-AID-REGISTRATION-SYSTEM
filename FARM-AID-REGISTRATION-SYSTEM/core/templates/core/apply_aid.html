{% extends "base.html" %}

{% block title %}Apply for Aid{% endblock %}

{% block content %}
<div class="apply-aid-container">
    <h2>Apply for Aid</h2>
    <p>Please fill out the form below to apply for aid.</p>

    <!-- Display messages -->
    {% if messages %}
        <div class="messages">
            {% for message in messages %}
                <p class="msg {{ message.tags }}">{{ message }}</p>
            {% endfor %}
        </div>
    {% endif %}

    <!-- Aid Availability Table -->
    <div class="aid-availability">
        <h3>Available Aid Resources</h3>

        <table class="aid-table">
            <thead>
                <tr>
                    <th>Resource</th>
                    <th>Quantity Available</th>
                    <th>Application Opens</th>
                    <th>Application Deadline</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for item in available_items %}
                    <tr class="main-item" onclick="toggleSubItems({{ item.id }})">
                        <td>
                            <span id="arrow-{{ item.id }}" class="toggle-arrow">▶</span>
                            {{ item.get_name_display }}
                        </td>
                        <td>{{ item.quantity_available }}</td>
                        <td>{{ item.application_start|date:"M d, Y" }}</td>
                        <td>{{ item.application_deadline|date:"M d, Y" }}</td>
                        <td>
                            {% if item.is_open_for_application %}
                                <span class="status-open">Open</span>
                            {% else %}
                                <span class="status-closed">Closed</span>
                            {% endif %}
                        </td>
                    </tr>

                    {% for sub in item.sub_items.all %}
                        <tr class="sub-item sub-of-{{ item.id }}">
                            <td><span class="sub-icon">↳</span>{{ sub.name }}</td>
                            <td>{{ sub.quantity_available }}</td>
                            <td colspan="3">Sub-item of {{ item.get_name_display }}</td>
                        </tr>
                    {% endfor %}
                {% endfor %}
            </tbody>
        </table>
    </div><br>

    <!-- Application Form -->
    <form method="POST" class="apply-form">
        {% csrf_token %}

        <div class="form-sections">
            <!-- Farmer Information -->
            <fieldset class="form-box">
                <legend>Farmer Information</legend>
                {{ farmer_form.as_p }}
            </fieldset>

            <!-- Aid Request -->
            <fieldset class="form-box">
                <legend>Aid Request</legend>
                
                <label for="aid-item-select">Select Aid Category:</label>
                <select id="aid-item-select" name="aid_item" class="form-control">
                    <option value="">Select a category</option>
                    {% for item in aid_form.fields.aid_item.queryset %}
                        <option value="{{ item.id }}">{{ item.get_name_display }}</option>
                    {% endfor %}
                </select><br>

                <label for="sub-aid-item-select">Select Specific Aid Type:</label>
                <select id="sub-aid-item-select" name="sub_aid_item" class="form-control">
                    <option value="">Select a sub-item</option>
                    {% for sub in aid_form.fields.sub_aid_item.queryset %}
                        <option value="{{ sub.id }}">{{ sub.name }}</option>
                    {% endfor %}
                </select><br>

               <label for="quantity_requested">Enter Quantity:</label>
<input type="number" name="quantity_requested" id="quantity_requested" min="1" required class="form-control">

            </fieldset>
        </div><br>

        <div class="form-actions">
            <button type="submit" class="btn-submit">Submit Application</button>
        </div>
    </form>
</div>

<!-- Dynamic Sub-item Loading -->
<script>
document.getElementById('aid-item-select').addEventListener('change', function() {
    const aidItemId = this.value;
    if (!aidItemId) return;

    fetch(`/get-sub-items/${aidItemId}/`)
        .then(response => response.json())
        .then(data => {
            const subAidSelect = document.getElementById('sub-aid-item-select');
            subAidSelect.innerHTML = '<option value="">Select a sub-item</option>';
            data.sub_items.forEach(sub => {
                const option = document.createElement('option');
                option.value = sub.id;
                option.textContent = sub.name;
                subAidSelect.appendChild(option);
            });
        })
        .catch(error => console.error('Error loading sub-items:', error));
});

// Collapse/expand sub-items
function toggleSubItems(itemId) {
    const rows = document.querySelectorAll(`.sub-of-${itemId}`);
    const arrow = document.getElementById(`arrow-${itemId}`);
    rows.forEach(row => {
        row.style.display = (row.style.display === 'table-row') ? 'none' : 'table-row';
    });
    arrow.textContent = (arrow.textContent === '▶') ? '▼' : '▶';
}
</script>

<style>
.apply-aid-container {
    max-width: 950px;
    margin: 30px auto;
    background: #fff;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* Collapsible Table Styles */
.aid-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    font-family: 'Segoe UI', sans-serif;
}
.aid-table th {
    background-color: #2e7d32;
    color: white;
    padding: 10px;
    text-align: left;
}
.aid-table td {
    padding: 10px;
    border-bottom: 1px solid #ddd;
}
tr.main-item {
    background-color: #f5fff5;
    font-weight: 600;
    cursor: pointer;
}
tr.sub-item {
    background-color: #fafafa;
    display: none;
}
tr.sub-item td {
    padding-left: 30px;
}
tr.main-item:hover {
    background-color: #e8f5e9;
}
.status-open {
    color: #2e7d32;
    font-weight: bold;
}
.status-closed {
    color: #d32f2f;
    font-weight: bold;
}
.sub-icon {
    color: #388e3c;
    font-weight: bold;
    margin-right: 6px;
}
.toggle-arrow {
    font-weight: bold;
    margin-right: 8px;
    color: #2e7d32;
}

/* Form styles */
.form-box {
    border: 1px solid #ccc;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 15px;
}
.btn-submit {
    background: #4CAF50;
    color: white;
    border: none;
    padding: 10px 20px;
    font-size: 1rem;
    border-radius: 6px;
    cursor: pointer;
}
.btn-submit:hover {
    background: #43a047;
}
</style>
{% endblock %}
